##############################
## Mass spectra case study
##############################

##############################
## load TIMP
##############################

require(TIMP)

##############################
## READ IN DATA
##############################

mdDat1<-readData("201103CBSG_32_1.cdf.txt")
mdDat2<-readData("201103CBSG_33_1.cdf.txt")

ms1 <- preProcess(data = mdDat1, sel_time_ab = c(1999,2030),
                  sel_lambda = c(2,100))
ms2 <- preProcess(data = mdDat2, sel_time_ab = c(1999,2030), 
                  sel_lambda = c(2,100))
  
##############################
## DEFINE INITIAL MODEL
##############################

model1 <- initModel(mod_type = "mass", 
extracomp = FALSE,                    
peakpar= list(
c( 2013.92786,  3.90388107,  0.168802917), #1
c(2023.04944, 3.77928138,  0.161704913  )), #2
amplitudes = rep(1,2),
fixed = list(amplitudes=1:2),
weightpar = list(
c(NA, NA, 2.5,44.5,.03), 
c(NA,NA,37.5,44.5,.03)))


##############################
## FIT MODEL
##############################

denRes1 <- fitModel(list(ms1,ms2),
                    list(model1),
modeldiffs = list( 
change = list(list(what = "fixed", dataset=2, spec = list()),
list(what = "amplitudes", dataset = 2, spec = c(1.28920472,  0.253247947)))),
opt=massopt(iter=100,
 linrange = .2, nnls = TRUE, summaryplotrow=4,summaryplotcol=5,
makeps = "MARI", xlab = "time", output = "pdf", algorithm="nls.lm",
ylab = "mass", 
nummaxtraces = 30))

##############################
## PLOTS FOR PAPER 
##############################

CC <- getXList(denRes1)

postscript("Cmass.ps")

par(cex=1.2, cex.axis=2.5, cex.lab=2.25,mar=c(5, 5, 4, 2) )

cv <- c(1,grey(.4))

matplot(CC[[2]], type="l", lty=2, lwd=2, ylab="",
        xlab="time (scan number)", col=cv)

matplot(CC[[1]], type="l", lty=1, lwd=2, add=TRUE, col=cv)

dev.off()

################ 

require(ALS)


EE <- getCLPList(denRes1)[[1]]

 source("~/mass_spec/ALS/ALS/R/plotSp.R")
plotS(EE, ms1@x2, out="ps", filename="Emass.ps", cex=2, col = cv,
      lab="m/z", cex.lab=3)

############### 

data1 <- getData(denRes1, 1)
data2 <- getData(denRes1, 2)

fit1 <- getTraces(denRes1, 1)
fit2 <- getTraces(denRes1, 2)

seltr <- c(17, 31, 32, 33, 37, 48)

weightM <- denRes1$currModel@modellist[[1]]@weightM

postscript("m2.ps")

par(mfrow=c(2,3),cex.lab=2.25, cex.axis=2.25, cex.main=2.5)

for(i in seltr) {
  
  f1 <- fit1[,i] / weightM[,i]
  f2 <- fit2[,i] / weightM[,i]

  plot(data2[,i], ylab="", xlab="time (scan number)",
       ylim=c(0, max(f2, f1)), col=cv[2],
       main=paste("Mass", ms1@x2[i]), type="p")
  lines(f2,col=cv[2], type="l")

  points(data1[,i])
  lines(f1, type="l")
}

dev.off()
